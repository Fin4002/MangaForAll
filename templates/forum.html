{% extends 'base.html' %}
{% block title %}Forum · MangaForAll{% endblock %}
{% block content %}

<div class="forum-layout">
  <aside class="forum-aside card fade-in">
    <div class="card-body">
      <h2 class="card-title">Top Contributors</h2>
      <ul class="contributors">
        {% for c in top_contributors %}
          <li class="contrib">
            {% if c.user_id %}
              <a
                href="{{ url_for('user_card', uid=c.user_id) }}"
                data-modal="user"
                class="row"
                style="gap:10px; align-items:center;"
                aria-label="Open {{ c.author or 'User' }}’s profile"
              >
                <img
                  class="avatar small"
                  src="{{ url_for('user_avatar', uid=c.user_id) }}?v={{ session.get('avatar_ver', 0) }}"
                  alt="{{ c.author or 'User' }}’s avatar"
                >
                <div class="who">
                  <div class="name">{{ c.author or 'Anonymous' }}</div>
                  <div class="muted">{{ c.total_contributions }} contributions</div>
                </div>
              </a>
            {% else %}
              <div class="avatar small">{{ (c.author or 'A')[:1] }}</div>
              <div class="who">
                <div class="name">{{ c.author or 'Anonymous' }}</div>
                <div class="muted">{{ c.total_contributions }} contributions</div>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
      <a href="{{ url_for('new_post') }}" class="btn block" style="margin-top:12px" aria-label="Create a new forum post">New Post</a>
    </div>
  </aside>

  <main class="forum-main">
    <h1 class="page-title">Forum</h1>

    {% if posts %}
      <div class="stack">
        {% for post in posts %}
          <article class="post card fade-in">
            <div class="post-click">
              <header class="post-header">
                {% set poster_uid = post.author_id or post.user_id %}
                {% if poster_uid %}
                  <a
                    href="{{ url_for('user_card', uid=poster_uid) }}"
                    data-modal="user"
                    class="row user-card-trigger"
                    style="gap:10px; align-items:center;"
                    aria-label="Open {{ post.author or 'User' }}’s profile"
                  >
                    <img
                      class="avatar poster"
                      src="{{ url_for('user_avatar', uid=poster_uid) }}?v={{ session.get('avatar_ver', 0) }}"
                      alt="{{ post.author or 'User' }}’s avatar"
                    >
                    <div class="meta">
                      <div class="name">{{ post.author or 'Anonymous' }}</div>
                      <div class="muted">Post #{{ post.post_id }}</div>
                    </div>
                  </a>
                {% else %}
                  <div class="avatar small">{{ (post.author or 'A')[:1] }}</div>
                  <div class="meta">
                    <div class="name">{{ post.author or 'Anonymous' }}</div>
                    <div class="muted">Post #{{ post.post_id }}</div>
                  </div>
                {% endif %}
              </header>

              <div class="post-body">
                <h3 class="post-title">{{ post.title }}</h3>
                <p class="post-text">{{ post.content }}</p>
                {% if post.image %}
                  <figure class="media">
                    <img
                      src="{{ url_for('post_image_blob', post_id=post.post_id) }}"
                      alt="Image attached to '{{ post.title }}'"
                      loading="lazy"
                      onerror="this.closest('.media')?.remove();"
                    >
                  </figure>
                {% endif %}
              </div>

              <footer class="post-footer">
                <div class="chips"><span class="chip">Discussion</span></div>
              </footer>

              <!-- Opens post detail modal -->
              <a class="post-link"
                 href="{{ url_for('post_detail', post_id=post.post_id) }}"
                 data-modal="post"
                 aria-label="Open post: {{ post.title }}"></a>
            </div>

            <section class="comments">
              <h4 class="comments-title">Comments</h4>
              {% set c_list = comments_by_post.get(post.post_id, []) %}
              {% if c_list %}
                <ul class="comment-list">
                  {% for c in c_list %}
                    <li class="comment">
                      {% if c.user_id %}
                        <a
                          href="{{ url_for('user_card', uid=c.user_id) }}"
                          data-modal="user"
                          aria-label="Open {{ c.username or 'User' }}’s profile"
                        >
                          <img
                            class="avatar tiny"
                            src="{{ url_for('user_avatar', uid=c.user_id) }}?v={{ session.get('avatar_ver', 0) }}"
                            alt="{{ c.username or 'User' }}’s avatar"
                          >
                        </a>
                      {% else %}
                        <div class="avatar tiny">{{ (c.username or 'A')[:1] }}</div>
                      {% endif %}
                      <div class="bubble">
                        {% if c.user_id %}
                          <a
                            href="{{ url_for('user_card', uid=c.user_id) }}"
                            data-modal="user"
                            class="who"
                            aria-label="Open {{ c.username or 'Anonymous' }}’s profile"
                          >{{ c.username or 'Anonymous' }}</a>
                        {% else %}
                          <div class="who">{{ c.username or 'Anonymous' }}</div>
                        {% endif %}
                        <p>{{ c.content }}</p>
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="muted">No comments yet.</p>
              {% endif %}

              {% if user %}
                <form method="POST" action="{{ url_for('add_comment', post_id=post.post_id) }}" class="comment-form">
                  <textarea name="content" class="input" rows="2" placeholder="Write a comment…" required></textarea>
                  <button type="submit" class="btn">Comment</button>
                </form>
              {% else %}
                <p class="muted">Please <a href="{{ url_for('login') }}">log in</a> to comment.</p>
              {% endif %}
            </section>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="card fade-in">
        <div class="card-body center">
          <h3 class="card-title" style="margin-bottom:6px">No posts yet</h3>
          <p class="card-sub">Start the chaos politely.</p>
          <a href="{{ url_for('new_post') }}" class="btn">Create the first post</a>
        </div>
      </div>
    {% endif %}
  </main>
</div>

<style>
  /* Ensure user links in post header sit above the full-card overlay link */
  .user-card-trigger { position: relative; z-index: 6; }

  /* Poster avatar */
  .avatar.poster {
    width: 50px;
    height: 50px;
    min-width: 50px;
    min-height: 50px;
    border-radius: 50%;
    box-shadow: var(--shadow);
    object-fit: cover;
  }
</style>

{% endblock %}
